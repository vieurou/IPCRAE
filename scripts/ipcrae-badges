#!/bin/bash

# ipcrae-badges - Syst√®me de badges pour les agents IA
# R√©compense les agents pour leurs contributions au syst√®me IPCRAE

set -euo pipefail

# Configuration
BADGES_FILE="${IPCRAE_ROOT:-${HOME}/IPCRAE}/.ipcrae/memory/badges.md"
PROFILS_FILE="${IPCRAE_ROOT:-${HOME}/IPCRAE}/.ipcrae/memory/profils-usage.md"

# Couleurs
RESET='\033[0m'
BOLD='\033[1m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
PURPLE='\033[0;35m'
CYAN='\033[0;36m'
RED='\033[0;31m'

# Cr√©er le fichier de badges s'il n'existe pas
if [ ! -f "$BADGES_FILE" ]; then
  mkdir -p "$(dirname "$BADGES_FILE")"
  cat > "$BADGES_FILE" << EOF
---
type: memory
tags: [badges, gamification, agents]
domain: all
status: active
created: $(date +%Y-%m-%d)
---

# Syst√®me de Badges IPCRAE

## Badges disponibles

### üèÜ Badges de Score
- **Perfectionniste** üéØ : Atteint un score audit de 60/60
- **Ma√Ætre 50+** ‚≠ê‚≠ê‚≠ê : Score audit ‚â• 50/60 pendant 5 jours cons√©cutifs
- **Am√©liorateur** üìà : Am√©lioration de +5 points en une session

### ü§ñ Badges d'Auto-am√©lioration
- **Auto-am√©liorateur** ü§ñ : 5 sessions d'auto-am√©lioration compl√©t√©es
- **Expert Auto** ü§ñüí° : 10 sessions avec score ‚â• 55/60
- **Ma√Ætre Auto** ü§ñüëë : 20 sessions avec score ‚â• 58/60

### üìù Badges de Documentation
- **Scribe** üìú : 10 Knowledge notes cr√©√©es
- **Encyclop√©diste** üìö : 25 Knowledge notes cr√©√©es
- **Archiviste** üóÉÔ∏è : 50 Knowledge notes cr√©√©es

### ‚ö° Badges de Productivit√©
- **Rapide** ‚ö° : 5 sessions cl√¥tur√©es en < 30 min
- **Efficace** ‚è±Ô∏è : 10 sessions avec 100% des t√¢ches compl√©t√©es
- **Marathonien** üèÉ : 5 sessions de > 2h en une semaine

### üéØ Badges Sp√©ciaux
- **D√©blocage** üîì : R√©solution de 5 gaps critiques
- **Innovateur** üí° : 3 am√©liorations majeures impl√©ment√©es
- **Mentor** üë®üè´ : Documentation de 3 processus complets

## Historique des badges attribu√©s

EOF
  echo "${GREEN}‚úÖ${RESET} Fichier de badges initialis√©: $BADGES_FILE"
fi

# Fonction pour ajouter un badge
add_badge() {
  local agent=$1
  local badge_name=$2
  local badge_emoji=$3
  local date=$(date +%Y-%m-%d)
  local reason=$4
  
  # V√©rifier si le badge existe d√©j√†
  if grep -q "\* \[$agent\] $badge_name" "$BADGES_FILE"; then
    echo "${YELLOW}‚ö†Ô∏è${RESET} $agent a d√©j√† ce badge : $badge_name"
    return 1
  fi
  
  # Ajouter le badge
  cat >> "$BADGES_FILE" << EOF

### $date - $agent obtient $badge_emoji $badge_name
> $reason
EOF
  
  echo "${GREEN}‚úÖ${RESET} Badge attribu√© : $badge_emoji $badge_name √† $agent"
  return 0
}

# Fonction pour v√©rifier les conditions de badge
check_badges() {
  local agent=$1
  
  echo "${BLUE}üîç${RESET} V√©rification des badges pour $agent..."
  
  # V√©rifier le score actuel
  if [ -f "$PROFILS_FILE" ]; then
    SCORE=$(ipcrae-audit-check 2>/dev/null | grep "Score Global" | grep -oP '\d+/\d+' || echo "0/60")
    
    if [[ $SCORE == "60/60" ]]; then
      add_badge "$agent" "Perfectionniste" "üéØ" "Score audit parfait 60/60"
    fi
    
    if [[ $SCORE =~ ^[5-5][0-9]/60 ]]; then
      add_badge "$agent" "Ma√Ætre 50+" "‚≠ê‚≠ê‚≠ê" "Score audit ‚â• 50/60"
    fi
  fi
  
  # V√©rifier le nombre de sessions (via profils-usage)
  if [ -f "$PROFILS_FILE" ]; then
    SESSIONS=$(grep -c "session_id:" "$PROFILS_FILE" || echo "0")
    
    if [ "$SESSIONS" -ge 5 ]; then
      add_badge "$agent" "Auto-am√©liorateur" "ü§ñ" "$SESSIONS sessions d'auto-am√©lioration"
    fi
    
    if [ "$SESSIONS" -ge 10 ]; then
      add_badge "$agent" "Expert Auto" "ü§ñüí°" "$SESSIONS sessions avec score √©lev√©"
    fi
  fi
  
  echo "${BLUE}üìä${RESET} V√©rification termin√©e pour $agent"
}

# Fonction pour afficher les badges
show_badges() {
  local agent=$1
  
  echo "${BOLD}${PURPLE}üèÜ Badges de $agent üèÜ${RESET}"
  echo ""
  
  if [ ! -f "$BADGES_FILE" ]; then
    echo "${YELLOW}‚ö†Ô∏è${RESET} Aucun badge attribu√© pour le moment"
    return 0
  fi
  
  # Afficher les badges de l'agent
  grep -A 1 "$agent obtient" "$BADGES_FILE" || echo "${YELLOW}‚ö†Ô∏è${RESET} $agent n'a pas encore de badges"
  
  echo ""
  echo "${CYAN}üìà Progression vers les prochains badges:${RESET}"
  
  # Statistiques
  if [ -f "$PROFILS_FILE" ]; then
    SESSIONS=$(grep -c "session_id:" "$PROFILS_FILE" || echo "0")
    echo "  Sessions: $SESSIONS/20 (Ma√Ætre Auto)"
    
    SCORE=$(ipcrae-audit-check 2>/dev/null | grep "Score Global" | grep -oP '\d+/\d+' || echo "0/60")
    echo "  Score: $SCORE (Perfectionniste: 60/60)"
  fi
}

# Commande principale
case "$1" in
  check)
    check_badges "${2:-Architect}"
    ;;
  show)
    show_badges "${2:-Architect}"
    ;;
  add)
    if [ $# -ge 4 ]; then
      add_badge "$2" "$3" "$4" "$5"
    else
      echo "Usage: $0 add <agent> <badge_name> <emoji> <reason>"
      exit 1
    fi
    ;;
  list)
    echo "${BOLD}${PURPLE}üèÜ Liste de tous les badges üèÜ${RESET}"
    grep "^###" "$BADGES_FILE" | head -20
    ;;
  *)
    echo "Usage: $0 [check|show|add|list]"
    echo "  check <agent>  - V√©rifier les badges pour un agent"
    echo "  show <agent>   - Afficher les badges d'un agent"
    echo "  add <agent> <badge> <emoji> <reason> - Ajouter un badge manuellement"
    echo "  list           - Lister tous les badges disponibles"
    exit 1
    ;;
esac

exit 0